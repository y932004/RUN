<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>RUNAway 管理者後台</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ... 樣式省略 ... */
  </style>
</head>
<body>
  <div class="box">
    <h2>RUNAway 管理者後台</h2>

    <div id="login-section">
      <h3>管理者登入 (使用 Secret Key)</h3>
      <input id="adminEmail" type="email" placeholder="管理員 Email">
      <input id="adminPassword" type="password" placeholder="管理員密碼">
      <button onclick="adminLogin()">登入管理員</button>
      <p id="loginMsg" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="admin-section" style="display: none;">
      <p>⚠️ **注意：此頁面使用 Secret Key，擁有完全的資料庫讀寫權限。**</p>
      
      <div class="section">
        <h3>💰 調整玩家金幣 (需有 `increment_wallet` RPC 函式)</h3>
        <input id="targetUser" type="number" placeholder="玩家 ID (profiles.id)" value="1">
        <input id="amount" type="number" placeholder="金額 (+/-)" value="100">
        <button onclick="adjustCoins()">執行調整</button>
        <p id="coinResult" style="margin-top: 10px;"></p>
      </div>

      <div class="section">
        <h3>🛒 新增商店商品 (items)</h3>
        <input id="itemCode" type="text" placeholder="代碼 (Code)">
        <input id="itemName" type="text" placeholder="名稱 (Name)">
        <input id="itemType" type="text" placeholder="類型 (Type)">
        <input id="itemPrice" type="number" placeholder="價格 (Price)">
        <input id="itemEmoji" type="text" placeholder="Emoji">
        <button onclick="addItem()">新增商品</button>
        <p id="itemResult" style="margin-top: 10px;"></p>
      </div>

      <button onclick="adminLogout()" style="background: #f44336; color: white; margin-top: 20px;">登出管理員</button>
    </div>

  </div>

  <script>
    // 🔔 警告：客戶端網頁使用 Secret Key 風險極高！
    // 這裡依您的要求，在 admin.html 中使用 Secret Key。
    const SUPABASE_URL = "https://mdeovnbheovrtyrrpdjp.supabase.co";
    const SUPABASE_KEY = "sb_secret_NdMNItTMqS_qT1BNORbwsw_C5DJs8vp"; // <-- 已替換為新的 Secret Key

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
            // 在 Secret Key 模式下，可以關閉 PKCE 避免錯誤
            flowType: 'pkce'
        }
    });

    const loginSection = document.getElementById("login-section");
    const adminSection = document.getElementById("admin-section");
    const loginMsg = document.getElementById("loginMsg");

    // 檢查登入狀態
    async function checkAdminLogin() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            loginSection.style.display = 'none';
            adminSection.style.display = 'block';
        } else {
            loginSection.style.display = 'block';
            adminSection.style.display = 'none';
        }
    }
    
    // 管理員登入
    async function adminLogin() {
        const email = document.getElementById("adminEmail").value;
        const password = document.getElementById("adminPassword").value;
        
        loginMsg.textContent = "⏳ 登入中...";
        
        // 使用 v2 的登入函式
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
        });

        if (error) {
            loginMsg.textContent = "登入錯誤：" + error.message;
        } else {
            loginMsg.textContent = "🎉 登入成功！";
            checkAdminLogin(); // 重新檢查狀態並顯示管理功能
        }
    }
    
    // 管理員登出
    async function adminLogout() {
        await supabase.auth.signOut();
        checkAdminLogin(); // 重新檢查狀態並顯示登入表單
    }


    /* ---------------- 調整金幣 ---------------- */
    async function adjustCoins() {
      const userId = parseInt(document.getElementById("targetUser").value);
      const amount = parseInt(document.getElementById("amount").value);

      if (!userId || !amount) {
        alert("請輸入玩家 ID 與金額");
        return;
      }

      // 建立交易紀錄
      const { error: txErr } = await supabase
        .from("coin_transactions")
        .insert({
          user_id: userId,
          change_amount: amount,
          reason: "admin_adjust"
        });

      if (txErr) {
        document.getElementById("coinResult").textContent =
          "錯誤： " + txErr.message;
        return;
      }

      // 更新錢包
      await supabase.rpc("increment_wallet", {  // 如果你沒有函式，我可以幫你寫
        x_user_id: userId,
        x_amount: amount
      });

      document.getElementById("coinResult").textContent =
        "成功操作金幣！";
    }

    /* ---------------- 新增商品 ---------------- */
    async function addItem() {
      const code = document.getElementById("itemCode").value;
      const name = document.getElementById("itemName").value;
      const type = document.getElementById("itemType").value;
      const price = parseInt(document.getElementById("itemPrice").value);
      const emoji = document.getElementById("itemEmoji").value;

      const { error } = await supabase
        .from("items")
        .insert({
          code: code,
          name: name,
          type: type,
          price: price,
          emoji: emoji,
        });

      if (error) {
        document.getElementById("itemResult").textContent =
          "錯誤： " + error.message;
      } else {
        document.getElementById("itemResult").textContent = "成功新增商品！";
      }
    }

    // 啟動
    checkAdminLogin();
  </script>
</body>
</html>