<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #0a3d62, #3c6382);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow-x: hidden;
    }

    h1 { margin: 10px 0; font-size: 24px; }

    .nav-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
    }
    .nav-buttons a {
      text-decoration: none;
      color: #fff;
      padding: 6px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .dashboard {
      width: 95%;
      max-width: 1200px;
      height: 88%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .top-section {
      display: flex;
      gap: 10px;
    }
    .info-box {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    .info-value { font-size: 26px; font-weight: bold; margin-top: 5px; }
    .info-small { font-size: 12px; opacity: 0.8; }

    .bottom-section { display: flex; flex: 1; gap: 10px; }
    .chart-box, .calendar {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 10px;
    }

    /* å¥½å‹ç³»çµ± */
    #friendSection {
      width: 95%;
      max-width: 1200px;
      margin-top: 8px;
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 10px;
    }
    #friendSection input {
      width: 220px;
      padding: 6px;
      border-radius: 6px;
      border: none;
    }
    #friendSection button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-left: 5px;
      background: #74b9ff;
      color: white;
    }
    #friendSection ul { padding-left: 20px; }
  </style>
  <link rel="stylesheet" href="ui.css">
</head>

<body>

<div class="nav-buttons">
  <a href="Homepage.html">â† è¿”å›é¦–é </a>
  <a href="Game.html">ğŸ® è¿”å›éŠæˆ²</a>
</div>

<h1 id="titleName">ğŸ† é‹å‹•å ±è¡¨</h1>

<div class="dashboard">

  <div class="top-section">
    <div class="info-box" style="border-top:4px solid #74b9ff;">
      <div>Reflex Ridge</div>
      <div class="info-value" id="myReflex">--</div>
      <div class="info-small" id="avgReflex">å¥½å‹å¹³å‡ï¼š--</div>
    </div>

    <div class="info-box" style="border-top:4px solid #55efc4;">
      <div>River Adventure</div>
      <div class="info-value" id="myRiver">--</div>
      <div class="info-small" id="avgRiver">å¥½å‹å¹³å‡ï¼š--</div>
    </div>

    <div class="info-box" style="border-top:4px solid #ffeaa7;">
      <div>Under The Sea</div>
      <div class="info-value" id="mySea">--</div>
      <div class="info-small" id="avgSea">å¥½å‹å¹³å‡ï¼š--</div>
    </div>
  </div>

  <div class="bottom-section">
    <div class="chart-box">
      <h3>ğŸ“Š é‹å‹•æ™‚é–“åˆ†ä½ˆï¼ˆç¤ºæ„ï¼‰</h3>
      <canvas id="stackedBar"></canvas>
    </div>

    <div class="calendar">
      <h3>ğŸ“… æœˆæ›†ç´€éŒ„ï¼ˆç¤ºæ„ï¼‰</h3>
      <input type="month" id="monthPicker" value="2025-10">
      <div id="calendarDisplay"></div>
    </div>
  </div>
</div>

<!-- å¥½å‹å€ -->
<div id="friendSection">
  <h3>ğŸ‘¥ å¥½å‹ç³»çµ±ï¼ˆé‚€è«‹ç¢¼ï¼‰</h3>

  <p>ä½ çš„é‚€è«‹ç¢¼ï¼š<b id="myInviteCode">è®€å–ä¸­...</b></p>

  <input id="inviteInput" type="text" placeholder="è¼¸å…¥å°æ–¹é‚€è«‹ç¢¼ï¼ˆUIDï¼‰">
    <input id="inviteEmailInput" type="text" placeholder="æˆ–è¼¸å…¥å°æ–¹ Email åŠ å¥½å‹">
  <button id="addFriendBtn">åŠ å¥½å‹</button>

  <h4>ğŸ“© æ”¶åˆ°çš„å¥½å‹é‚€è«‹</h4>
  <ul id="receivedList"></ul>

  <h4>ğŸ‘« æˆ‘çš„å¥½å‹</h4>
  <ul id="friendList"></ul>
</div>

<script type="module">

/* ---------------- Firebase ---------------- */
import { 
  doc, getDoc, setDoc, updateDoc,
  arrayUnion, arrayRemove, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { auth, db, onAuth, findUserByEmail, addSportReport, getUserProfile } from './firebase-utils.js';
import { showModal, hideModal, showToast, showCameraMissing } from './ui.js';

/* ---------------- UI å…ƒç´  ---------------- */
const myReflex = document.getElementById("myReflex");
const myRiver  = document.getElementById("myRiver");
const mySea    = document.getElementById("mySea");

const avgReflex = document.getElementById("avgReflex");
const avgRiver  = document.getElementById("avgRiver");
const avgSea    = document.getElementById("avgSea");

const inviteInput = document.getElementById("inviteInput");
const addFriendBtn = document.getElementById("addFriendBtn");

const myInviteCode = document.getElementById("myInviteCode");
const receivedList = document.getElementById("receivedList");
const friendList = document.getElementById("friendList");

let currentUser = null;

/* ---------------- ç™»å…¥å¾Œæµç¨‹ ---------------- */
onAuth(async (user) => {
  if (!user) { location.href = "Login.html"; return; }

  currentUser = user;
  try {
    try {
      const profile = await getUserProfile(user.uid);
      const displayName = (profile && profile.nickname) || user.displayName || user.email;
      myInviteCode.textContent = user.uid;
      document.getElementById("titleName").textContent = `ğŸ† ${displayName} çš„é‹å‹•å ±è¡¨`;
    } catch(e) {
      console.warn('getUserProfile failed', e);
      myInviteCode.textContent = user.uid;
      document.getElementById("titleName").textContent = `ğŸ† ${user.email} çš„é‹å‹•å ±è¡¨`;
    }

    await ensureUserExists();
    await loadMyStats();
    await loadFriendData();
  } catch (err) {
    console.error('Report init failed', err);
    showToast('è¼‰å…¥å ±è¡¨é å¤±æ•—ï¼Œè«‹æ–¼ console æŸ¥çœ‹éŒ¯èª¤');
  }
});

/* ---------------- è‹¥ Firestore æ²’è³‡æ–™ â†’ è‡ªå‹•è£œ ---------------- */
async function ensureUserExists() {
  const ref = doc(db, "users", currentUser.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(ref, {
      email: currentUser.email,
      nickname: currentUser.email.split("@")[0],
      stats: { reflex: 0, river: 0, sea: 0 },
      friends: [],
      friendRequests: { sent: [], received: [] }
    });
    return;
  }

  // è£œç¼ºå°‘æ¬„ä½ï¼ˆé¿å… undefined éŒ¯èª¤ï¼‰
  const data = snap.data();
  let changed = false;

  if (!data.stats) { data.stats = { reflex: 0, river: 0, sea: 0 }; changed = true; }
  if (!data.friends) { data.friends = []; changed = true; }
  if (!data.friendRequests) { data.friendRequests = { sent: [], received: [] }; changed = true; }
  if (!data.friendRequests.sent) { data.friendRequests.sent = []; changed = true; }
  if (!data.friendRequests.received) { data.friendRequests.received = []; changed = true; }

  if (changed) await setDoc(ref, data, { merge: true });
}

/* ---------------- è®€è‡ªå·±çš„åˆ†æ•¸ ---------------- */
async function loadMyStats() {
  const snap = await getDoc(doc(db, "users", currentUser.uid));
  const data = snap.data() || {};
  const s = data.stats || { reflex: 0, river: 0, sea: 0 };

  myReflex.textContent = typeof s.reflex === 'number' ? s.reflex : 0;
  myRiver.textContent  = typeof s.river === 'number' ? s.river : 0;
  mySea.textContent    = typeof s.sea === 'number' ? s.sea : 0;
}

/* ---------------- è®€å¥½å‹ + å¹³å‡ ---------------- */
async function loadFriendData() {
  const ref = doc(db, "users", currentUser.uid);
  const me = await getDoc(ref);
  const d = me.data();

  const friends = d.friends || [];

  let count = 0;
  let sum = { reflex: 0, river: 0, sea: 0 };

  friendList.innerHTML = "";

  for (let uid of friends) {
    const fSnap = await getDoc(doc(db, "users", uid));
    if (!fSnap.exists()) continue;
    const fd = fSnap.data();

    // æœ‹å‹çš„ stats å¯èƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨å®‰å…¨é è¨­
    const fs = fd.stats || { reflex: 0, river: 0, sea: 0 };
    count++;
    sum.reflex += (typeof fs.reflex === 'number') ? fs.reflex : 0;
    sum.river  += (typeof fs.river === 'number') ? fs.river : 0;
    sum.sea    += (typeof fs.sea === 'number') ? fs.sea : 0;

    const li = document.createElement("li");
    li.textContent = fd.nickname || fd.email;
    friendList.appendChild(li);
  }

  avgReflex.textContent = count ? `å¥½å‹å¹³å‡ï¼š${(sum.reflex / count).toFixed(1)}` : "å¥½å‹å¹³å‡ï¼š--";
  avgRiver .textContent = count ? `å¥½å‹å¹³å‡ï¼š${(sum.river  / count).toFixed(1)}` : "å¥½å‹å¹³å‡ï¼š--";
  avgSea   .textContent = count ? `å¥½å‹å¹³å‡ï¼š${(sum.sea    / count).toFixed(1)}` : "å¥½å‹å¹³å‡ï¼š--";

  loadFriendRequests();
}

/* ---------------- é¡¯ç¤ºæ”¶åˆ°çš„å¥½å‹é‚€è«‹ï¼ˆå·²ä¿®æ­£ï¼‰ ---------------- */
async function loadFriendRequests() {
  const snap = await getDoc(doc(db, "users", currentUser.uid));
  const data = snap.data();

  const received = data.friendRequests.received || [];

  receivedList.innerHTML = "";

  for (let senderUID of received) {
    const senderSnap = await getDoc(doc(db, "users", senderUID));
    if (!senderSnap.exists()) continue;

    const sender = senderSnap.data();

    const li = document.createElement("li");
    li.innerHTML = `
      ${sender.nickname || sender.email}
      <button class="accept">æ¥å—</button>
      <button class="reject">æ‹’çµ•</button>
    `;

    /* æ¥å—å¥½å‹é‚€è«‹ */
    li.querySelector(".accept").onclick = async () => {
      await updateDoc(doc(db, "users", currentUser.uid), {
        friends: arrayUnion(senderUID),
        "friendRequests.received": arrayRemove(senderUID)
      });

      await updateDoc(doc(db, "users", senderUID), {
        friends: arrayUnion(currentUser.uid),
        "friendRequests.sent": arrayRemove(currentUser.uid)
      });

      loadFriendData();
    };

    /* æ‹’çµ•å¥½å‹é‚€è«‹ */
    li.querySelector(".reject").onclick = async () => {
      await updateDoc(doc(db, "users", currentUser.uid), {
        "friendRequests.received": arrayRemove(senderUID)
      });

      await updateDoc(doc(db, "users", senderUID), {
        "friendRequests.sent": arrayRemove(currentUser.uid)
      });

      loadFriendData();
    };

    receivedList.appendChild(li);
  }
}

/* ---------------- ä½¿ç”¨é‚€è«‹ç¢¼ï¼ˆUIDï¼‰åŠ å¥½å‹ ---------------- */
addFriendBtn.addEventListener("click", async () => {
  const targetUID = inviteInput.value.trim();
  if (!targetUID) return alert("è«‹è¼¸å…¥é‚€è«‹ç¢¼ï¼ˆUIDï¼‰");
  if (targetUID === currentUser.uid) return alert("ä¸èƒ½åŠ è‡ªå·±ï¼");

  const targetSnap = await getDoc(doc(db, "users", targetUID));
  if (!targetSnap.exists()) return alert("æŸ¥ç„¡æ­¤é‚€è«‹ç¢¼ï¼");

  await updateDoc(doc(db, "users", currentUser.uid), {
    "friendRequests.sent": arrayUnion(targetUID)
  });

  await updateDoc(doc(db, "users", targetUID), {
    "friendRequests.received": arrayUnion(currentUser.uid)
  });

  alert("å¥½å‹é‚€è«‹å·²é€å‡ºï¼");
  inviteInput.value = "";
});

// é€é Email åŠ å¥½å‹ï¼ˆæ–¹ä¾¿ï¼‰
document.getElementById('inviteEmailInput').addEventListener('keydown', async (e) => {
  if (e.key !== 'Enter') return;
  const email = e.target.value.trim();
  if (!email) return;
  try {
    const found = await findUserByEmail(email);
    if (!found) return alert('æŸ¥ç„¡æ­¤ Email çš„ä½¿ç”¨è€…');
    const targetUID = found.uid;
    if (targetUID === currentUser.uid) return alert('ä¸èƒ½åŠ è‡ªå·±');
    await updateDoc(doc(db, 'users', currentUser.uid), { 'friendRequests.sent': arrayUnion(targetUID) });
    await updateDoc(doc(db, 'users', targetUID), { 'friendRequests.received': arrayUnion(currentUser.uid) });
    showToast('å¥½å‹é‚€è«‹å·²é€å‡º');
    e.target.value = '';
  } catch (err) { console.error(err); showToast('åŠ å¥½å‹å¤±æ•—'); }
});

/* ---------------- é¡¯ç¤ºæˆ‘çš„ sportReportsï¼ˆç°¡æ˜“ï¼‰ ---------------- */
async function loadMyReports(){
  try {
    const snaps = await getDocs(collection(db, 'users', currentUser.uid, 'sportReports'));
    const list = document.createElement('div');
    list.style.maxHeight='240px'; list.style.overflow='auto';
    snaps.forEach(s=>{
      const d = s.data();
      const el = document.createElement('div');
      const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : '';
      el.innerHTML = `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.04)"><b>${d.game}</b> ${d.score} <br><small>${ts}</small></div>`;
      list.appendChild(el);
    });
    if (snaps.empty) list.innerHTML = '<p>å°šç„¡é‹å‹•å ±å‘Š</p>';
    showModal({ title: 'æˆ‘çš„é‹å‹•ç´€éŒ„', body: list, buttons:[{label:'é—œé–‰',cls:'ghost',onClick:hideModal}] });
  } catch (err) {
    console.error('loadMyReports failed', err);
    showToast('è¼‰å…¥é‹å‹•ç´€éŒ„å¤±æ•—');
  }
}

// åœ¨é é¢åŠ å…¥æŒ‰éˆ•ä»¥æª¢è¦–æˆ‘çš„å ±å‘Š
const reportsBtn = document.createElement('button'); reportsBtn.textContent='æª¢è¦–æˆ‘çš„é‹å‹•ç´€éŒ„'; reportsBtn.style.marginLeft='12px';
reportsBtn.onclick = loadMyReports;
document.querySelector('.nav-buttons').appendChild(reportsBtn);

/* ---------------- é•·æ¢åœ–ï¼ˆç¤ºæ„è³‡æ–™ï¼‰ ---------------- */
new Chart(document.getElementById("stackedBar"), {
  type: 'bar',
  data: {
    labels: ['é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­','é€±æ—¥'],
    datasets: [
      { label: 'Reflex Ridge', data: [10,20,30,40,35,20,10], backgroundColor: '#74b9ff' },
      { label: 'River Adventure', data: [5,15,25,20,15,10,5], backgroundColor: '#55efc4' },
      { label: 'Under The Sea', data: [8,12,18,22,15,9,6], backgroundColor: '#ffeaa7' }
    ]
  },
  options: { scales: { x: { stacked: true }, y: { stacked: true } } }
});


// ---------------- æœˆæ›†èˆ‡æœˆä»½æª¢è¦– ----------------
const monthPickerEl = document.getElementById('monthPicker');
const calendarDisplay = document.getElementById('calendarDisplay');
(function setDefaultMonth(){
  try {
    const now = new Date();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    monthPickerEl.value = `${now.getFullYear()}-${mm}`;
  } catch(e){ console.warn(e); }
})();

monthPickerEl.addEventListener('change', () => { renderMonthReports(); });

async function renderMonthReports(){
  if (!currentUser) return; // å°šæœªç™»å…¥
  const val = monthPickerEl.value; if(!val) return;
  const [y, m] = val.split('-').map(v=>parseInt(v,10));
  try {
    const snaps = await getDocs(collection(db, 'users', currentUser.uid, 'sportReports'));
    const days = {}; // map day -> reports[]
    snaps.forEach(s=>{
      const d = s.data();
      let dateObj = null;
      if (d.createdAt && d.createdAt.toDate) dateObj = d.createdAt.toDate();
      else if (d.createdAt && d.createdAt instanceof Date) dateObj = d.createdAt;
      else if (d.createdAt && typeof d.createdAt === 'string') dateObj = new Date(d.createdAt);
      else dateObj = null;
      if (!dateObj) return;
      if (dateObj.getFullYear() !== y || (dateObj.getMonth()+1) !== m) return;
      const day = dateObj.getDate();
      days[day] = days[day] || [];
      days[day].push(d);
    });

    // render
    const keys = Object.keys(days).map(Number).sort((a,b)=>a-b);
    calendarDisplay.innerHTML = '';
    if (keys.length === 0) {
      calendarDisplay.innerHTML = '<p>æœ¬æœˆå°šç„¡é‹å‹•ç´€éŒ„</p>';
      return;
    }
    keys.forEach(day => {
      const box = document.createElement('div');
      box.style.padding = '8px'; box.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
      const header = document.createElement('div'); header.style.fontWeight='bold'; header.textContent = `æ—¥æœŸï¼š${y}/${m}/${day}`;
      box.appendChild(header);
      days[day].forEach(r => {
        const p = document.createElement('div'); p.style.fontSize='14px'; p.style.marginTop='4px';
        const ts = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : (r.createdAt instanceof Date ? r.createdAt.toLocaleString() : '');
        p.textContent = `${r.game} â€” åˆ†æ•¸ï¼š${r.score} (${ts})`;
        box.appendChild(p);
      });
      calendarDisplay.appendChild(box);
    });
  } catch(err) {
    console.error('renderMonthReports failed', err);
    calendarDisplay.innerHTML = '<p>è¼‰å…¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console</p>';
  }
}

// åœ¨åˆå§‹åŒ–å¾Œè¼‰å…¥æœ¬æœˆè³‡æ–™
(async function(){
  // ç•¶é é¢åˆå§‹åŒ–å®Œæˆä¸”ä½¿ç”¨è€…å·²è¼‰å…¥å¾Œï¼Œå˜—è©¦ render
  try { await new Promise(resolve => setTimeout(resolve, 300)); renderMonthReports(); } catch(e){/*ignore*/}
})();

</script>

</body>
</html>
