<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #0a3d62, #3c6382);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    h1 { margin: 10px 0; font-size: 24px; }

    /* è¿”å›æŒ‰éˆ• */
    .nav-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
    }
    .nav-buttons a {
      text-decoration: none;
      color: #fff;
      padding: 6px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* å¤–å±¤å¸ƒå±€ */
    .dashboard {
      width: 95%;
      max-width: 1200px;
      height: 90%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .top-section {
      display: flex;
      gap: 10px;
    }
    .info-box {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    .info-value {
      font-size: 28px;
      font-weight: bold;
      margin-top: 5px;
    }
    .info-small { font-size: 12px; opacity: 0.8; }

    .bottom-section { display: flex; gap: 10px; height: 100%; }
    .chart-box, .calendar {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 10px;
    }

    /* å¥½å‹ç³»çµ± */
    #friendSection {
      width: 95%;
      max-width: 1200px;
      margin-top: 10px;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 10px;
    }
    #friendSection input {
      width: 220px;
      padding: 5px;
      border-radius: 6px;
      border: none;
    }
    #friendSection button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      margin-left: 5px;
      background: #74b9ff;
      color: white;
    }
  </style>
</head>

<body>

<div class="nav-buttons">
  <a href="Homepage.html">â† è¿”å›é¦–é </a>
  <a href="Game.html">ğŸ® è¿”å›éŠæˆ²</a>
</div>

<h1 id="titleName">ğŸ† é‹å‹•å ±è¡¨</h1>

<div class="dashboard">

  <!-- åˆ†æ•¸å€ -->
  <div class="top-section">
    <div class="info-box" style="border-top:4px solid #74b9ff;">
      <div>Reflex Ridge</div>
      <div class="info-value" id="myReflex">--</div>
      <div class="info-small" id="avgReflex">å¥½å‹å¹³å‡ï¼š--</div>
    </div>

    <div class="info-box" style="border-top:4px solid #55efc4;">
      <div>River Adventure</div>
      <div class="info-value" id="myRiver">--</div>
      <div class="info-small" id="avgRiver">å¥½å‹å¹³å‡ï¼š--</div>
    </div>

    <div class="info-box" style="border-top:4px solid #ffeaa7;">
      <div>Under The Sea</div>
      <div class="info-value" id="mySea">--</div>
      <div class="info-small" id="avgSea">å¥½å‹å¹³å‡ï¼š--</div>
    </div>
  </div>

  <!-- åœ–è¡¨ & æœˆæ›† -->
  <div class="bottom-section">
    <div class="chart-box">
      <h3>ğŸ“Š é‹å‹•æ™‚é–“åˆ†ä½ˆï¼ˆç¤ºæ„ï¼‰</h3>
      <canvas id="stackedBar"></canvas>
    </div>

    <div class="calendar">
      <h3>ğŸ“… é‹å‹•ç´€éŒ„ï¼ˆç¤ºæ„ï¼‰</h3>
      <input type="month" id="monthPicker" value="2025-10">
      <div id="calendarDisplay"></div>
    </div>
  </div>
</div>

<!-- å¥½å‹ç³»çµ± -->
<div id="friendSection">
  <h3>ğŸ‘¥ å¥½å‹ç³»çµ±ï¼ˆé‚€è«‹ç¢¼ï¼‰</h3>

  <p>ä½ çš„é‚€è«‹ç¢¼ï¼š<b id="myInviteCode">è®€å–ä¸­...</b></p>

  <input id="inviteInput" type="text" placeholder="è¼¸å…¥å°æ–¹çš„é‚€è«‹ç¢¼ï¼ˆUIDï¼‰">
  <button id="addFriendBtn">åŠ å¥½å‹</button>

  <h4>ğŸ“© æ”¶åˆ°çš„å¥½å‹é‚€è«‹</h4>
  <ul id="receivedList"></ul>

  <h4>ğŸ‘« æˆ‘çš„å¥½å‹</h4>
  <ul id="friendList"></ul>
</div>


<script type="module">

/* ------------------------------
    Firebase Import
------------------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, query, where, getDocs,
  arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


/* ------------------------------
    Firebase è¨­å®š
------------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyB9dkg-ZKdgU9rNur3XodRYSnBZkHfldGI",
  authDomain: "runrun-21a19.firebaseapp.com",
  projectId: "runrun-21a19",
  storageBucket: "runrun-21a19.firebasestorage.app",
  messagingSenderId: "57222188374",
  appId: "1:57222188374:web:ea4bf396424bdbca9d9af7",
  measurementId: "G-PS1B2X8NS2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


/* ------------------------------
    å…¨åŸŸè®Šæ•¸
------------------------------ */
let currentUser = null;

const myReflex = document.getElementById("myReflex");
const myRiver  = document.getElementById("myRiver");
const mySea    = document.getElementById("mySea");

const avgReflex = document.getElementById("avgReflex");
const avgRiver  = document.getElementById("avgRiver");
const avgSea    = document.getElementById("avgSea");

const inviteInput = document.getElementById("inviteInput");
const addFriendBtn = document.getElementById("addFriendBtn");

const receivedList = document.getElementById("receivedList");
const friendList = document.getElementById("friendList");


/* ------------------------------
    ç™»å…¥å¾Œä¸»æµç¨‹
------------------------------ */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "Login.html";
    return;
  }

  currentUser = user;
  document.getElementById("titleName").innerText =
    `ğŸ† ${user.email} çš„é‹å‹•å ±è¡¨`;

  document.getElementById("myInviteCode").innerText = user.uid;

  await ensureUserDocExists();
  await loadMyStats();
  await loadFriendData();
});


/* ------------------------------
    è‡ªå‹•è£œä¸Š Firestore ä½¿ç”¨è€…è³‡æ–™
------------------------------ */
async function ensureUserDocExists() {
  const ref = doc(db, "users", currentUser.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(ref, {
      email: currentUser.email,
      nickname: currentUser.email.split("@")[0],
      coins: 0,
      friends: [],
      friendRequests: { sent: [], received: [] },
      stats: { reflex: 0, river: 0, sea: 0 },
      createdAt: new Date(),
      lastUpdated: new Date()
    });
  }
}


/* ------------------------------
    è®€è‡ªå·±çš„éŠæˆ²åˆ†æ•¸
------------------------------ */
async function loadMyStats() {
  const ref = doc(db, "users", currentUser.uid);
  const snap = await getDoc(ref);
  const d = snap.data();

  myReflex.innerText = d.stats.reflex;
  myRiver.innerText  = d.stats.river;
  mySea.innerText    = d.stats.sea;
}


/* ------------------------------
    è®€å¥½å‹è³‡æ–™ + å¹³å‡åˆ†æ•¸
------------------------------ */
async function loadFriendData() {
  const ref = doc(db, "users", currentUser.uid);
  const me = await getDoc(ref);
  const d = me.data();

  const friends = d.friends || [];

  let c = 0;
  let sum = { reflex: 0, river: 0, sea: 0 };

  friendList.innerHTML = "";

  for (let uid of friends) {
    const f = await getDoc(doc(db, "users", uid));
    if (!f.exists()) continue;

    const fd = f.data();

    c++;
    sum.reflex += fd.stats.reflex;
    sum.river  += fd.stats.river;
    sum.sea    += fd.stats.sea;

    const li = document.createElement("li");
    li.textContent = fd.nickname || fd.email;
    friendList.appendChild(li);
  }

  avgReflex.innerText = c ? `å¥½å‹å¹³å‡ï¼š${(sum.reflex/c).toFixed(1)}` : "å¥½å‹å¹³å‡ï¼š--";
  avgRiver.innerText  = c ? `å¥½å‹å¹³å‡ï¼š${(sum.river/c).toFixed(1)}`  : "å¥½å‹å¹³å‡ï¼š--";
  avgSea.innerText    = c ? `å¥½å‹å¹³å‡ï¼š${(sum.sea/c).toFixed(1)}`    : "å¥½å‹å¹³å‡ï¼š--";

  loadFriendRequests();
}


/* ------------------------------
    é¡¯ç¤ºæ”¶åˆ°çš„å¥½å‹é‚€è«‹
------------------------------ */
async function loadFriendRequests() {
  const me = await getDoc(doc(db, "users", currentUser.uid));
  const d = me.data();

  receivedList.innerHTML = "";

  for (let senderUID of d.friendRequests.received) {
    const snap = await getDoc(doc(db, "users", senderUID));
    const fd = snap.data();

    const li = document.createElement("li");
    li.innerHTML = `
      ${fd.nickname || fd.email}
      <button class="accept">æ¥å—</button>
      <button class="reject">æ‹’çµ•</button>
    `;

    li.querySelector(".accept").onclick = async () => {
      await updateDoc(doc(db, "users", currentUser.uid), {
        friends: arrayUnion(senderUID),
        "friendRequests.received": arrayRemove(senderUID)
      });

      await updateDoc(doc(db, "users", senderUID), {
        friends: arrayUnion(currentUser.uid),
        "friendRequests.sent": arrayRemove(currentUser.uid)
      });

      loadFriendData();
    };

    li.querySelector(".reject").onclick = async () => {
      await updateDoc(doc(db, "users", currentUser.uid), {
        "friendRequests.received": arrayRemove(senderUID)
      });

      await updateDoc(doc(db, "users", senderUID), {
        "friendRequests.sent": arrayRemove(currentUser.uid)
      });

      loadFriendData();
    };

    receivedList.appendChild(li);
  }
}


/* ------------------------------
    åŠ å¥½å‹ï¼ˆä½¿ç”¨ UID é‚€è«‹ç¢¼ï¼‰
------------------------------ */
addFriendBtn.addEventListener("click", async () => {
  const targetUID = inviteInput.value.trim();
  if (!targetUID) return alert("è«‹è¼¸å…¥é‚€è«‹ç¢¼");
  if (targetUID === currentUser.uid) return alert("ä¸èƒ½åŠ è‡ªå·±ï¼");

  const ref = doc(db, "users", targetUID);
  const snap = await getDoc(ref);

  if (!snap.exists()) return alert("æŸ¥ç„¡æ­¤é‚€è«‹ç¢¼ï¼");

  await updateDoc(doc(db, "users", currentUser.uid), {
    "friendRequests.sent": arrayUnion(targetUID)
  });

  await updateDoc(doc(db, "users", targetUID), {
    "friendRequests.received": arrayUnion(currentUser.uid)
  });

  alert("å¥½å‹é‚€è«‹å·²é€å‡ºï¼");
  inviteInput.value = "";
});


/* ------------------------------
    é•·æ¢åœ–ï¼ˆç¤ºæ„å‡è³‡æ–™ï¼‰
------------------------------ */
const ctx = document.getElementById('stackedBar');

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­','é€±æ—¥'],
    datasets: [
      { label: 'Reflex Ridge', data: [15,20,25,10,5,15,20], backgroundColor: '#74b9ff' },
      { label: 'River Adventure', data: [10,15,20,5,10,10,15], backgroundColor: '#55efc4' },
      { label: 'Under The Sea', data: [5,10,15,5,0,10,5], backgroundColor: '#ffeaa7' },
    ]
  },
  options: {
    scales: { x: { stacked: true }, y: { stacked: true } }
  }
});

</script>

</body>
</html>
