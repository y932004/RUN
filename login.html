<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>RUNAway ç™»å…¥ç³»çµ±</title>
  <!-- Supabase JavaScript SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f5f5f5;
    }
    .box {
      background: white;
      padding: 25px;
      width: 350px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin: auto;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    #msg {
      white-space: pre-wrap;
      color: #333;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="box">
    <h2 style="text-align:center;">RUNAway ç™»å…¥ / è¨»å†Š</h2>

    <label>Email</label>
    <input id="email" type="email" placeholder="è«‹è¼¸å…¥ Email">

    <label>å¯†ç¢¼</label>
    <input id="password" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ (è‡³å°‘ 6 ç¢¼)">

    <label>æš±ç¨±ï¼ˆè¨»å†Šç”¨ï¼‰</label>
    <input id="displayName" type="text" placeholder="Ex: å°å°è·‘è€…">

    <button onclick="signup()">è¨»å†Šæ–°å¸³è™Ÿ</button>
    <button onclick="login()">ç™»å…¥</button>

    <pre id="msg"></pre>
  </div>

  <script>
    /* --------------- â‘  æ›¿æ›æˆä½ çš„ Supabase URL & anon key --------------- */
    const SUPABASE_URL = "ðŸ‘‰ åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Project URL ðŸ‘ˆ";
    const SUPABASE_ANON = "ðŸ‘‰ åœ¨é€™è£¡è²¼ä¸Šä½ çš„ anon public key ðŸ‘ˆ";

    /* ------------------------------------------------------------------- */

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const msgEl = document.getElementById("msg");
    function showMsg(t) { msgEl.textContent = t; }

    /* ===================== â‘¡ è¨»å†Š ===================== */
    async function signup() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const displayName = document.getElementById("displayName").value || "æœªå‘½åçŽ©å®¶";

      if (!email || !password) {
        showMsg("è«‹è¼¸å…¥ email èˆ‡å¯†ç¢¼");
        return;
      }

      // Step 1: ä½¿ç”¨ Supabase Auth å‰µå»ºå¸³è™Ÿ
      const { data, error } = await supabase.auth.signUp({
        email,
        password
      });

      if (error) {
        showMsg("è¨»å†Šå¤±æ•—ï¼š" + error.message);
        return;
      }

      const authUser = data.user;

      // Step 2: åœ¨ public.users å»ºç«‹å°æ‡‰è³‡æ–™åˆ—
      const { error: insertErr } = await supabase
        .from("users")
        .insert({
          auth_user_id: authUser.id,
          username: email,
          display_name: displayName,
          role: "user"
        });

      if (insertErr) {
        showMsg("è¨»å†ŠæˆåŠŸï¼Œä½†ç„¡æ³•å»ºç«‹çŽ©å®¶è³‡æ–™ï¼š" + insertErr.message);
        return;
      }

      showMsg("è¨»å†ŠæˆåŠŸï¼è«‹æŸ¥æ”¶é©—è­‰ä¿¡ã€‚\n\nä½ ç¾åœ¨å¯ä»¥ä½¿ç”¨ Email/å¯†ç¢¼ç™»å…¥ã€‚");
    }

    /* ===================== â‘¢ ç™»å…¥ ===================== */
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      if (!email || !password) {
        showMsg("è«‹è¼¸å…¥ email èˆ‡å¯†ç¢¼");
        return;
      }

      // Step 1: ç”¨ email + å¯†ç¢¼ç™»å…¥ Supabase Auth
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        showMsg("ç™»å…¥å¤±æ•—ï¼š" + error.message);
        return;
      }

      const authUser = data.user;

      // Step 2: æŸ¥è©¢ public.users å…§å°æ‡‰è³‡æ–™
      const { data: userRow, error: userErr } = await supabase
        .from("users")
        .select("*")
        .eq("auth_user_id", authUser.id)
        .single();

      if (userErr) {
        showMsg("ç™»å…¥æˆåŠŸï¼Œä½†æ‰¾ä¸åˆ°çŽ©å®¶è³‡æ–™ï¼š" + userErr.message);
        return;
      }

      showMsg("ç™»å…¥æˆåŠŸï¼\næ­¡è¿Žï¼š" + userRow.display_name + 
              "\nè§’è‰²ï¼š" + userRow.role +
              "\n\nå³å°‡å°Žå‘...");

      // æ ¹æ“šè§’è‰²å°Žåˆ°ä¸åŒé é¢
      setTimeout(() => {
        if (userRow.role === "admin") {
          window.location.href = "admin.html";
        } else {
          window.location.href = "dashboard.html";
        }
      }, 1500);
    }
  </script>

</body>
</html>
